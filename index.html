<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Consulta Insumos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; text-align: center; }
        .box { background: white; padding: 20px; border-radius: 10px; max-width: 400px; margin: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        select, input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        .item { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
    </style>
</head>
<body>
    <div class="box">
        <h2>Pesquisa de Insumos</h2>
        <select id="o" onchange="at()"><option>Carregando...</option></select>
        <select id="s" onchange="ex()" disabled><option>Obra...</option></select>
        <div id="ba" style="display:none">
            <input type="text" id="bu" placeholder="Filtrar..." onkeyup="fi()">
            <div id="li"></div>
        </div>
    </div>

    <script>
        const U = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeWoUzGEPCsqfLGQwpwe80rWBZomnX7gEZ4gH-73GbNzKA5UussFtVCJ-POS2fY5gIIYHiO7F1D6uq/pub?gid=0&single=true&output=csv';
        let d = [], a = [];

        window.onload = () => {
            Papa.parse(U, {
                download: true, header: true, skipEmptyLines: true,
                complete: r => {
                    d = r.data;
                    const obras = [...new Set(d.map(i => i.OBRA))].filter(x => x);
                    const sel = document.getElementById('o');
                    sel.innerHTML = '<option value="">-- Selecione a Obra --</option>';
                    obras.forEach(x => sel.add(new Option(x, x)));
                }
            });
        };

        function at() {
            const v = document.getElementById('o').value;
            const sel = document.getElementById('s');
            const servs = [...new Set(d.filter(i => i.OBRA === v).map(i => i.SERVIÇO))].filter(x => x);
            sel.innerHTML = '<option value="">-- Selecione o Serviço --</option>';
            servs.forEach(x => sel.add(new Option(x, x)));
            sel.disabled = false;
        }

        function ex() {
            const ob = document.getElementById('o').value;
            const se = document.getElementById('s').value;
            a = d.filter(i => i.OBRA === ob && i.SERVIÇO === se).map(i => i.INSUMO).filter(x => x);
            document.getElementById('ba').style.display = 'block';
            re(a);
        }

        function re(l) {
            document.getElementById('li').innerHTML = l.map(i => `<div class="item">${i}</div>`).join('');
        }

        function fi() {
            const t = document.getElementById('bu').value.toLowerCase();
            re(a.filter(i => i.toLowerCase().includes(t)));
        }
    </script>
</body>
</html>